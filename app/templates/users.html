{% extends "base.html" %}

{% block title %}Gerenciar Usuários{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-4">
	<div>
		<h2 class="fw-bold mb-1"><i class="fas fa-users me-2 text-primary"></i> Usuários do Sistema</h2>
		<p class="text-muted mb-0">Gerencie quem pode acessar e o que cada usuário pode fazer.</p>
	</div>
	<button type="button" class="btn btn-primary px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
		<i class="fas fa-user-plus me-2"></i> Adicionar Usuário
	</button>
</div>

<div class="row">
	{% for user in users %}
	<div class="col-md-4 mb-4">
		<div
			class="card shadow-sm border-0 border-top border-4 {% if user.role == 'admin' %}border-danger{% else %}border-primary{% endif %}">
			<div class="card-body p-4">
				<div class="d-flex align-items-center mb-3">
					<div class="rounded-circle bg-light p-3 me-3">
						<i
							class="fas fa-user fa-2x {% if user.role == 'admin' %}text-danger{% else %}text-primary{% endif %}"></i>
					</div>
					<div>
						<h5 class="card-title mb-0 fw-bold">
							{{ user.username }}
							{% if not user.active %}
							<span class="badge bg-secondary ms-2">INATIVO</span>
							{% endif %}
							{% if user.password_reset_requested %}
							<span class="badge bg-warning text-dark ms-2"><i
									class="fas fa-exclamation-triangle me-1"></i> SOLICITANDO RESET</span>
							{% endif %}
						</h5>
						<span class="badge {% if user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %} mt-1">
							{{ user.role|upper }}
						</span>
						<div class="mt-2 small text-muted">
							<i class="fas fa-envelope me-1"></i> {{ user.email or 'S/ e-mail' }}
						</div>
					</div>
				</div>
				<p class="small text-muted mb-4">Registros de logs: {{ user.logs|length }}</p>
				<div class="d-grid gap-2">
					<!-- Resetar Senha -->
					{% if user.id != current_user.id %}
					<button
						class="btn btn-sm {% if user.password_reset_requested %}btn-warning text-dark fw-bold{% else %}btn-outline-secondary{% endif %}"
						data-bs-toggle="modal" data-bs-target="#resetPasswordModal{{ user.id }}">
						<i class="fas fa-key me-1"></i> Resetar Senha
					</button>
					{% endif %}

					<!-- Ativar / Desativar -->
					{% if user.id != current_user.id %}
					<button
						class="btn btn-sm {% if user.active %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
						data-bs-toggle="modal" data-bs-target="#toggleUserModal{{ user.id }}">
						<i class="fas {% if user.active %}fa-user-slash{% else %}fa-user-check{% endif %} me-1"></i>
						{% if user.active %}Desativar{% else %}Ativar{% endif %}
					</button>
					{% endif %}

					<!-- Alterar Perfil -->
					{% if user.id != current_user.id %}
					<button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
						data-bs-target="#changeRoleModal{{ user.id }}">
						<i class="fas fa-user-cog me-1"></i> Alterar Perfil
					</button>

					<button class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
						data-bs-target="#changeEmailModal{{ user.id }}">
						<i class="fas fa-envelope me-1"></i> Alterar E-mail
					</button>

					<button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
						data-bs-target="#deleteUserModal{{ user.id }}">
						<i class="fas fa-trash-alt me-1"></i> Excluir
					</button>
					{% endif %}
				</div>

			</div>
		</div>
	</div>
	{% endfor %}
</div>

<!-- All User Modals Moved Out of Cards to Fix Stacking Context -->
{% for user in users %}
{% if user.id != current_user.id %}
<!-- Modal Resetar Senha -->
<div class="modal fade" id="resetPasswordModal{{ user.id }}" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form method="POST" action="{{ url_for('main.reset_user_password', id=user.id) }}"
			class="modal-content glass-effect">
			<div class="modal-header bg-warning">
				<h5 class="modal-title">
					<i class="fas fa-key me-2"></i> Resetar Senha
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-body">
				<p>Deseja realmente resetar a senha do usuário <strong>{{ user.username }}</strong>?</p>
				<p class="text-muted small">A senha será redefinida para o padrão.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="submit" class="btn btn-warning">Confirmar</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Ativar / Desativar Usuário -->
<div class="modal fade" id="toggleUserModal{{ user.id }}" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form method="POST" action="{{ url_for('main.toggle_user_status', id=user.id) }}"
			class="modal-content glass-effect">
			<div class="modal-header {% if user.active %}bg-danger{% else %}bg-success{% endif %} text-white border-0">
				<h5 class="modal-title">
					<i class="fas {% if user.active %}fa-user-slash{% else %}fa-user-check{% endif %} me-2"></i>
					{% if user.active %}Desativar{% else %}Ativar{% endif %} Usuário
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body text-body">
				<p>Tem certeza que deseja <strong>{% if user.active %}desativar{% else %}ativar{% endif %}</strong> o
					usuário <strong>{{ user.username }}</strong>?</p>
			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="submit"
					class="btn {% if user.active %}btn-danger{% else %}btn-success{% endif %}">Confirmar</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Alterar Perfil -->
<div class="modal fade" id="changeRoleModal{{ user.id }}" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form method="POST" action="{{ url_for('main.change_user_role', id=user.id) }}"
			class="modal-content glass-effect">
			<div class="modal-header bg-primary text-white border-0">
				<h5 class="modal-title"><i class="fas fa-user-cog me-2"></i> Alterar Perfil</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body text-body">
				<div class="mb-3">
					<label class="form-label fw-bold small">Perfil para {{ user.username }}</label>
					<select class="form-select" name="role" required>
						<option value="user" {% if user.role=='user' %}selected{% endif %}>Usuário</option>
						<option value="admin" {% if user.role=='admin' %}selected{% endif %}>Administrador</option>
					</select>
				</div>
			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="submit" class="btn btn-primary">Salvar</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Alterar E-mail -->
<div class="modal fade" id="changeEmailModal{{ user.id }}" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<form method="POST" action="{{ url_for('main.change_user_email', id=user.id) }}"
			class="modal-content glass-effect">
			<div class="modal-header bg-info text-white border-0">
				<h5 class="modal-title"><i class="fas fa-envelope me-2"></i> Alterar E-mail</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body text-body">
				<div class="mb-3">
					<label class="form-label fw-bold small">E-mail para {{ user.username }}</label>
					<input type="email" class="form-control" name="email" value="{{ user.email or '' }}" required>
				</div>
			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="submit" class="btn btn-info text-white">Salvar</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal Excluir Usuário -->
<div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content glass-effect">
			<div class="modal-header bg-danger text-white border-0">
				<h5 class="modal-title"><i class="fas fa-user-times me-2"></i> Confirmar Exclusão</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body text-body">
				<p>Tem certeza que deseja excluir permanentemente o usuário <strong>{{ user.username }}</strong>?</p>
				<div class="alert alert-danger mb-0 small">
					<i class="fas fa-exclamation-triangle me-1"></i> Esta ação não pode ser desfeita.
				</div>
			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<form method="POST" action="{{ url_for('main.delete_user', id=user.id) }}" class="d-inline">
					<button type="submit" class="btn btn-danger">Confirmar Exclusão</button>
				</form>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endfor %}

<!-- Modal Novo Usuário -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content glass-effect border-0">
			<div class="modal-header bg-primary text-white border-0">
				<h5 class="modal-title" id="addUserModalLabel"><i class="fas fa-user-plus me-2"></i> Novo Usuário</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<form action="{{ url_for('main.add_user') }}" method="POST">
				<div class="modal-body text-body">
					<div class="mb-3">
						<label for="username" class="form-label fw-bold small">Nome de Usuário</label>
						<input type="text" class="form-control" id="username" name="username" required
							placeholder="Ex: joao.silva">
					</div>
					<div class="mb-3">
						<label for="email" class="form-label fw-bold small">E-mail</label>
						<input type="email" class="form-control" id="email" name="email" required
							placeholder="exemplo@email.com">
					</div>
					<div class="mb-3">
						<label for="password" class="form-label fw-bold small">Senha Inicial</label>
						<input type="password" class="form-control" id="password" name="password" required minlength="4"
							placeholder="Mínimo 4 caracteres">
					</div>
					<div class="mb-3">
						<label for="role" class="form-label fw-bold small">Perfil / Permissão</label>
						<select class="form-select" id="role" name="role">
							<option value="user">Usuário Comum (Visualização)</option>
							<option value="admin">Administrador (Acesso Total)</option>
						</select>
					</div>
				</div>
				<div class="modal-footer border-0">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary px-4">Criar Usuário</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}