{% extends "base.html" %}

{% block title %}Dispositivos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-4">
    <div>
        <h2 class="fw-bold mb-1"><i class="fas fa-server me-2 text-primary"></i> Dispositivos de Rede</h2>
        <p class="text-muted mb-0">
            {% if active_range %}
            Mostrando apenas dispositivos na faixa <span class="badge bg-primary">{{ active_range }}</span>
            <a href="{{ url_for('main.devices') }}" class="btn btn-sm btn-link text-decoration-none p-0 ms-2">
                <i class="fas fa-times-circle"></i> Limpar Filtro
            </a>
            {% else %}
            Gerencie todos os dispositivos cadastrados no sistema.
            {% endif %}
        </p>
    </div>
    {% if current_user.role == 'admin' %}
    <div>
        <button type="button" class="btn btn-info px-4 shadow-sm me-2 text-white" data-bs-toggle="modal"
            data-bs-target="#scanModal">
            <i class="fas fa-network-wired me-2"></i> Escanear Rede
        </button>
        <a href="{{ url_for('main.add_device') }}" class="btn btn-primary px-4 shadow-sm">
            <i class="fas fa-plus me-2"></i> Novo Dispositivo
        </a>
    </div>
    {% endif %}
</div>

<!-- Scan Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-network-wired me-2"></i>Escanear Rede</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.scan_network') }}" method="POST" onsubmit="return showLoading()">
                <div class="modal-body">
                    <p class="text-muted small">Insira a faixa de IP que deseja escanear. O sistema irá adicionar
                        automaticamente os dispositivos encontrados.</p>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">IP Inicial</label>
                            <input type="text" class="form-control" name="ip_start" placeholder="192.168.0.1" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">IP Final</label>
                            <input type="text" class="form-control" name="ip_end" placeholder="192.168.0.50" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnScan">
                        <i class="fas fa-search me-2"></i> Iniciar Scan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay"
    class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center"
    style="z-index: 9999;">
    <div class="text-center text-white">
        <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="fw-bold">Escaneando Rede...</h4>
        <p>Isso pode levar alguns minutos.</p>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-4">
        <div id="tableToolbar" class="row g-3 mb-4 align-items-center">
            <div class="col-md-auto" id="lengthContainer">
                <!-- DataTables length menu will be moved here -->
            </div>
            <div class="col-md-auto">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-layer-group text-primary"></i>
                    </span>
                    <select id="filterGroup" class="form-select border-start-0 ps-0" onchange="applyFilters()">
                        <option value="">Todos os grupos</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}" {% if current_group==group.id %}selected{% endif %}>{{
                            group.nome_grupo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-md-auto">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-network-wired text-primary"></i>
                    </span>
                    <select id="filterNetwork" class="form-select border-start-0 ps-0" onchange="applyFilters()">
                        <option value="">Todas as Redes</option>
                        {% for net in networks %}
                        <option value="{{ net }}" {% if current_network==net %}selected{% endif %}>{{ net }}.x</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-md-auto">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-tablet-alt text-primary"></i>
                    </span>
                    <select id="filterType" class="form-select border-start-0 ps-0" onchange="applyFilters()">
                        <option value="">Todos os tipos</option>
                        <option value="3D" {% if current_type=='3D' %}selected{% endif %}>3D</option>
                        <option value="Celular" {% if current_type=='Celular' %}selected{% endif %}>Celular</option>
                        <option value="Console" {% if current_type=='Console' %}selected{% endif %}>Console</option>
                        <option value="Desktop" {% if current_type=='Desktop' %}selected{% endif %}>Desktop</option>
                        <option value="Firewall" {% if current_type=='Firewall' %}selected{% endif %}>Firewall</option>
                        <option value="Inkjet Multifuncional" {% if current_type=='Inkjet Multifuncional' %}selected{%
                            endif %}>Inkjet Multifuncional
                        </option>
                        <option value="Interruptor" {% if current_type=='Interruptor' %}selected{% endif %}>Interruptor
                        </option>
                        <option value="LAN" {% if current_type=='LAN' %}selected{% endif %}>LAN</option>
                        <option value="Laser Multifuncional" {% if current_type=='Laser Multifuncional' %}selected{%
                            endif %}>Laser Multifuncional
                        </option>
                        <option value="Notebook" {% if current_type=='Notebook' %}selected{% endif %}>Notebook</option>
                        <option value="Plotter" {% if current_type=='Plotter' %}selected{% endif %}>Plotter</option>
                        <option value="Portable" {% if current_type=='Portable' %}selected{% endif %}>Portable</option>
                        <option value="Roteador" {% if current_type=='Roteador' %}selected{% endif %}>Roteador</option>
                        <option value="Sensor" {% if current_type=='Sensor' %}selected{% endif %}>Sensor</option>
                        <option value="Servidor" {% if current_type=='Servidor' %}selected{% endif %}>Servidor</option>
                        <option value="Smart IR" {% if current_type=='Smart IR' %}selected{% endif %}>Smart IR</option>
                        <option value="Smart Speaker" {% if current_type=='Smart Speaker' %}selected{% endif %}>Smart
                            Speaker</option>
                        <option value="Storage" {% if current_type=='Storage' %}selected{% endif %}>Storage</option>
                        <option value="Switch" {% if current_type=='Switch' %}selected{% endif %}>Switch</option>
                        <option value="Tablet" {% if current_type=='Tablet' %}selected{% endif %}>Tablet</option>
                        <option value="Térmica" {% if current_type=='Térmica' %}selected{% endif %}>Térmica</option>
                        <option value="Tomada" {% if current_type=='Tomada' %}selected{% endif %}>Tomada</option>
                    </select>
                </div>
            </div>

            <div class="col text-end" id="searchContainer">
                <!-- DataTables search will be moved here -->
            </div>
        </div>
        <div class="table-responsive">
            <table id="devicesTable" class="table table-hover align-middle" style="width:100%">
                <thead>
                    <tr>
                        <th style="width: 60px;">Status</th>
                        <th>Usuário</th>
                        <th>Hostname</th>
                        <th>Modelo / Service Tag</th>
                        <th>IP / MAC</th>
                        <th>Grupo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td class="text-center">
                            {% if device.status %}
                            <span class="badge bg-success rounded-circle p-2" title="Online">
                                <span class="visually-hidden">Online</span>
                            </span>
                            {% else %}
                            <span class="badge bg-secondary rounded-circle p-2" title="Offline">
                                <span class="visually-hidden">Offline</span>
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="small">
                                {% if device.usuario_atual %}
                                <i class="fas fa-user-circle me-1 text-muted"></i>{{ device.usuario_atual }}
                                {% else %}
                                <span class="text-muted italic small">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold text-dark">{{ device.nome_local }}</div>
                            <div class="small text-muted">{{ device.tipo }}</div>
                        </td>
                        <td>
                            <div class="text-secondary">{{ device.modelo or '-' }}</div>
                            {% if device.service_tag %}
                            <div class="small text-muted"><i class="fas fa-tag me-1"></i>{{ device.service_tag }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <div><code class="text-primary fw-bold">{{ device.ip }}</code></div>
                            <div class="small text-muted">{{ device.mac or '-' }}</div>
                        </td>
                        <td>
                            {% if device.group %}
                            <div class="badge bg-light text-dark border mb-1 d-block text-start">{{
                                device.group.nome_grupo }}</div>
                            {% else %}
                            <div class="badge bg-secondary text-white border mb-1 d-block text-start">Sem Grupo</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('main.edit_device', id=device.id) }}"
                                    class="btn btn-sm btn-outline-secondary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if current_user.role == 'admin' %}
                                <form action="{{ url_for('main.delete_device', id=device.id) }}" method="POST"
                                    class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger btn-delete"
                                        title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const group = document.getElementById('filterGroup').value;
        const network = document.getElementById('filterNetwork').value;
        const urlParams = new URLSearchParams(window.location.search);

        if (type) {
            urlParams.set('device_type', type);
        } else {
            urlParams.delete('device_type');
        }

        if (group) {
            urlParams.set('group_id', group);
        } else {
            urlParams.delete('group_id');
        }

        if (network) {
            urlParams.set('network', network);
        } else {
            urlParams.delete('network');
        }

        window.location.search = urlParams.toString();
    }

    function showLoading() {
        // Hide modal
        var modal = bootstrap.Modal.getInstance(document.getElementById('scanModal'));
        modal.hide();

        // Show overlay
        document.getElementById('loadingOverlay').classList.remove('d-none');
        return true;
    }
</script>
{% endblock %}